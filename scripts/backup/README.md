# è³‡æ–™åº«å‚™ä»½èˆ‡é‚„åŸèªªæ˜

## ç›®éŒ„çµæ§‹

```
scripts/backup/
â”œâ”€â”€ backup.sh          # å‚™ä»½è…³æœ¬
â”œâ”€â”€ restore.sh         # é‚„åŸè…³æœ¬
â”œâ”€â”€ setup-cron.sh      # è‡ªå‹•æ’ç¨‹è¨­å®šè…³æœ¬
â””â”€â”€ README.md          # æœ¬èªªæ˜æ–‡ä»¶

backups/               # å‚™ä»½æª”æ¡ˆå„²å­˜ç›®éŒ„ï¼ˆè‡ªå‹•å»ºç«‹ï¼‰
â”œâ”€â”€ timerecord_backup_20231226_120000.sql.gz
â”œâ”€â”€ timerecord_backup_20231226_140000.sql.gz
â””â”€â”€ backup.log         # å‚™ä»½æ—¥èªŒ
```

## å¿«é€Ÿé–‹å§‹

### æœ¬åœ°é–‹ç™¼ç’°å¢ƒ

#### 1. æ‰‹å‹•åŸ·è¡Œå‚™ä»½

```bash
cd scripts/backup
./backup.sh
```

å‚™ä»½æª”æ¡ˆæœƒå„²å­˜åœ¨ `backups/` ç›®éŒ„ï¼Œæª”åæ ¼å¼ç‚º `timerecord_backup_YYYYMMDD_HHMMSS.sql.gz`

### Zeabur éƒ¨ç½²ç’°å¢ƒ

#### 1. è¨­å®šç’°å¢ƒè®Šæ•¸

```bash
cd scripts/backup
cp zeabur.env.example zeabur.env
# ç·¨è¼¯ zeabur.envï¼Œå¡«å…¥ Zeabur PostgreSQL çš„ DATABASE_URL
```

å¾ Zeabur æ§åˆ¶å°å–å¾— DATABASE_URLï¼š
1. é€²å…¥ Zeabur å°ˆæ¡ˆ
2. é»é¸ PostgreSQL æœå‹™
3. è¤‡è£½ "Connection String" æˆ– "DATABASE_URL"

#### 2. åŸ·è¡Œå‚™ä»½

```bash
cd scripts/backup
./zeabur-backup-auto.sh
```

å‚™ä»½æª”æ¡ˆæœƒå„²å­˜åœ¨ `backups/zeabur/` ç›®éŒ„

### 2. è¨­å®šè‡ªå‹•å‚™ä»½

```bash
cd scripts/backup
./setup-cron.sh
```

æ ¹æ“šæç¤ºé¸æ“‡å‚™ä»½æ™‚é–“å’Œä¿ç•™å¤©æ•¸ã€‚

### 3. é‚„åŸè³‡æ–™åº«

```bash
cd scripts/backup
./restore.sh ../../backups/timerecord_backup_20231226_120000.sql.gz
```

## è©³ç´°èªªæ˜

### backup.sh - å‚™ä»½è…³æœ¬

**åŠŸèƒ½ï¼š**
- ä½¿ç”¨ `pg_dump` å‚™ä»½æ•´å€‹ PostgreSQL è³‡æ–™åº«
- è‡ªå‹•å£“ç¸®å‚™ä»½æª”æ¡ˆï¼ˆgzipï¼‰
- è‡ªå‹•æ¸…ç†éæœŸå‚™ä»½
- é¡¯ç¤ºå‚™ä»½ç‹€æ…‹å’Œæª”æ¡ˆå¤§å°

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
./backup.sh [ä¿ç•™å¤©æ•¸]
```

**åƒæ•¸ï¼š**
- `ä¿ç•™å¤©æ•¸`ï¼šï¼ˆå¯é¸ï¼‰ä¿ç•™å¤šå°‘å¤©å…§çš„å‚™ä»½ï¼Œé è¨­ 30 å¤©

**ç¯„ä¾‹ï¼š**
```bash
# ä½¿ç”¨é è¨­ä¿ç•™ 30 å¤©
./backup.sh

# ä¿ç•™æœ€è¿‘ 7 å¤©çš„å‚™ä»½
./backup.sh 7

# ä¿ç•™æœ€è¿‘ 90 å¤©çš„å‚™ä»½
./backup.sh 90
```

**è¼¸å‡ºï¼š**
```
================================================
ğŸ”„ é–‹å§‹å‚™ä»½è³‡æ–™åº«...
================================================
æ™‚é–“ï¼š2023-12-26 12:00:00
è³‡æ–™åº«ï¼šlocalhost:5432/timerecord
å‚™ä»½ä½ç½®ï¼š/path/to/backups/timerecord_backup_20231226_120000.sql
ä¿ç•™å¤©æ•¸ï¼š30 å¤©
================================================
ğŸ“¦ æ­£åœ¨å‚™ä»½è³‡æ–™åº«...
âœ… å‚™ä»½æˆåŠŸï¼
   æª”æ¡ˆï¼štimerecord_backup_20231226_120000.sql
   å¤§å°ï¼š2.4M
ğŸ—œï¸  æ­£åœ¨å£“ç¸®å‚™ä»½æª”æ¡ˆ...
âœ… å£“ç¸®å®Œæˆï¼
   å£“ç¸®å¾Œï¼š456K

ğŸ§¹ æ¸…ç†è¶…é 30 å¤©çš„èˆŠå‚™ä»½...
   å·²åˆªé™¤ï¼štimerecord_backup_20231126_120000.sql.gz
âœ… å·²åˆªé™¤ 1 å€‹èˆŠå‚™ä»½

ğŸ“‹ ç›®å‰å‚™ä»½æ¸…å–®ï¼š
   timerecord_backup_20231226_120000.sql.gz (456K)
   timerecord_backup_20231225_120000.sql.gz (455K)

================================================
âœ… å‚™ä»½å®Œæˆï¼
================================================
```

### restore.sh - é‚„åŸè…³æœ¬

**åŠŸèƒ½ï¼š**
- å¾å‚™ä»½æª”æ¡ˆé‚„åŸè³‡æ–™åº«
- æ”¯æ´å£“ç¸®æª”æ¡ˆï¼ˆ.sql.gzï¼‰
- é›™é‡ç¢ºèªæ©Ÿåˆ¶é˜²æ­¢èª¤æ“ä½œ
- é‚„åŸå¾Œé©—è­‰è³‡æ–™è¡¨

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
./restore.sh <å‚™ä»½æª”æ¡ˆè·¯å¾‘>
```

**ç¯„ä¾‹ï¼š**
```bash
./restore.sh ../../backups/timerecord_backup_20231226_120000.sql.gz
```

**è­¦å‘Šï¼š**
- âš ï¸ é‚„åŸæ“ä½œæœƒåˆªé™¤ç›®å‰è³‡æ–™åº«ä¸­çš„æ‰€æœ‰è³‡æ–™
- âš ï¸ æ­¤æ“ä½œç„¡æ³•å¾©åŸ
- âš ï¸ è«‹ç¢ºä¿åœ¨åŸ·è¡Œå‰å·²å‚™ä»½ç›®å‰è³‡æ–™

**è¼¸å‡ºï¼š**
```
================================================
âš ï¸  è­¦å‘Šï¼šè³‡æ–™åº«é‚„åŸ
================================================
å³å°‡é‚„åŸçš„å‚™ä»½ï¼štimerecord_backup_20231226_120000.sql.gz
ç›®æ¨™è³‡æ–™åº«ï¼šlocalhost:5432/timerecord

âš ï¸  é€™å€‹æ“ä½œå°‡æœƒï¼š
   1. åˆªé™¤ç›®å‰è³‡æ–™åº«ä¸­çš„æ‰€æœ‰è³‡æ–™è¡¨
   2. å¾å‚™ä»½æª”æ¡ˆé‚„åŸæ‰€æœ‰è³‡æ–™
   3. ç„¡æ³•å¾©åŸï¼

ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ(yes/no) yes

è«‹å†æ¬¡ç¢ºèªï¼ˆè¼¸å…¥ YES ç¹¼çºŒï¼‰ï¼šYES

================================================
ğŸ”„ é–‹å§‹é‚„åŸè³‡æ–™åº«...
================================================
æ™‚é–“ï¼š2023-12-26 12:05:00
ğŸ“¦ æ­£åœ¨è§£å£“ç¸®å‚™ä»½æª”æ¡ˆ...
ğŸ”„ æ­£åœ¨é‚„åŸè³‡æ–™åº«...
âœ… é‚„åŸæˆåŠŸï¼

ğŸ” é©—è­‰é‚„åŸçµæœ...
   è³‡æ–™è¡¨æ•¸é‡ï¼š4

ğŸ“‹ è³‡æ–™è¡¨æ¸…å–®ï¼š
 table_name
-----------------
 deduction_mappings
 employees
 records
 session

================================================
âœ… é‚„åŸå®Œæˆï¼
================================================
```

### setup-cron.sh - è‡ªå‹•æ’ç¨‹è¨­å®š

**åŠŸèƒ½ï¼š**
- äº’å‹•å¼è¨­å®š cron è‡ªå‹•å‚™ä»½æ’ç¨‹
- æª¢æŸ¥ä¸¦ç§»é™¤èˆŠçš„æ’ç¨‹è¨­å®š
- è‡ªè¨‚å‚™ä»½æ™‚é–“å’Œä¿ç•™å¤©æ•¸

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
./setup-cron.sh
```

**äº’å‹•æµç¨‹ï¼š**
```
================================================
ğŸ”§ è¨­å®šè‡ªå‹•å‚™ä»½æ’ç¨‹
================================================
å°ˆæ¡ˆè·¯å¾‘ï¼š/path/to/timerecord
å‚™ä»½è…³æœ¬ï¼š/path/to/scripts/backup/backup.sh

è«‹é¸æ“‡å‚™ä»½æ™‚é–“ï¼š
1) æ¯æ—¥å‡Œæ™¨ 2:00
2) æ¯æ—¥å‡Œæ™¨ 3:00
3) æ¯æ—¥å‡Œæ™¨ 4:00
4) æ¯ 6 å°æ™‚åŸ·è¡Œä¸€æ¬¡
5) æ¯ 12 å°æ™‚åŸ·è¡Œä¸€æ¬¡
6) è‡ªè¨‚æ™‚é–“

è«‹é¸æ“‡ (1-6): 1

è«‹è¼¸å…¥å‚™ä»½ä¿ç•™å¤©æ•¸ (é è¨­ 30): 30

å³å°‡æ–°å¢ä»¥ä¸‹æ’ç¨‹ï¼š
  æ™‚é–“ï¼šæ¯æ—¥å‡Œæ™¨ 2:00
  ä¿ç•™å¤©æ•¸ï¼š30 å¤©
  å‘½ä»¤ï¼š0 2 * * * /path/to/backup.sh 30 >> /path/to/backups/backup.log 2>&1

ç¢ºå®šè¦æ–°å¢å—ï¼Ÿ(yes/no) yes

âœ… æ’ç¨‹è¨­å®šå®Œæˆï¼

================================================
ğŸ“‹ ç›®å‰çš„æ’ç¨‹è¨­å®šï¼š
================================================
# è£œä¼‘ç™»éŒ„ç³»çµ±è‡ªå‹•å‚™ä»½ - æ¯æ—¥å‡Œæ™¨ 2:00
0 2 * * * /path/to/backup.sh 30 >> /path/to/backups/backup.log 2>&1

================================================
ğŸ“ ç®¡ç†æŒ‡ä»¤ï¼š
================================================
æŸ¥çœ‹æ’ç¨‹ï¼šcrontab -l
ç·¨è¼¯æ’ç¨‹ï¼šcrontab -e
ç§»é™¤æ’ç¨‹ï¼šcrontab -r
æŸ¥çœ‹æ—¥èªŒï¼štail -f /path/to/backups/backup.log
```

## ç®¡ç†æŒ‡ä»¤

### æŸ¥çœ‹ç›®å‰çš„å‚™ä»½æ’ç¨‹
```bash
crontab -l
```

### æ‰‹å‹•ç·¨è¼¯æ’ç¨‹
```bash
crontab -e
```

### ç§»é™¤æ‰€æœ‰æ’ç¨‹
```bash
crontab -r
```

### æŸ¥çœ‹å‚™ä»½æ—¥èªŒ
```bash
tail -f ../../backups/backup.log
```

### åˆ—å‡ºæ‰€æœ‰å‚™ä»½æª”æ¡ˆ
```bash
ls -lh ../../backups/
```

### æ‰‹å‹•æ¸…ç†èˆŠå‚™ä»½
```bash
# åˆªé™¤ 30 å¤©å‰çš„å‚™ä»½
find ../../backups -name "timerecord_backup_*.sql.gz" -mtime +30 -delete
```

## Cron æ™‚é–“æ ¼å¼èªªæ˜

```
* * * * * å‘½ä»¤
â”‚ â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€ æ˜ŸæœŸå¹¾ (0 - 7) (0 å’Œ 7 éƒ½ä»£è¡¨æ˜ŸæœŸæ—¥)
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€ æœˆä»½ (1 - 12)
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€ æ—¥æœŸ (1 - 31)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ™‚ (0 - 23)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é˜ (0 - 59)
```

**å¸¸ç”¨ç¯„ä¾‹ï¼š**
- `0 2 * * *` - æ¯å¤©å‡Œæ™¨ 2:00
- `0 */6 * * *` - æ¯ 6 å°æ™‚åŸ·è¡Œä¸€æ¬¡
- `0 2 * * 0` - æ¯é€±æ—¥å‡Œæ™¨ 2:00
- `0 2 1 * *` - æ¯æœˆ 1 æ—¥å‡Œæ™¨ 2:00
- `30 3 * * 1-5` - é€±ä¸€åˆ°é€±äº”å‡Œæ™¨ 3:30

## æ³¨æ„äº‹é …

### 1. ç’°å¢ƒè®Šæ•¸è¨­å®š
ç¢ºä¿ `api/.env` æª”æ¡ˆåŒ…å«æ­£ç¢ºçš„ `DATABASE_URL`ï¼š
```env
DATABASE_URL=postgresql://user:password@localhost:5432/timerecord
```

### 2. PostgreSQL å·¥å…·
ç¢ºä¿ç³»çµ±å·²å®‰è£ PostgreSQL å®¢æˆ¶ç«¯å·¥å…·ï¼š
```bash
# macOS
brew install postgresql

# Ubuntu/Debian
sudo apt-get install postgresql-client

# é©—è­‰å®‰è£
pg_dump --version
psql --version
```

### 3. æ¬Šé™å•é¡Œ
ç¢ºä¿è…³æœ¬æœ‰åŸ·è¡Œæ¬Šé™ï¼š
```bash
chmod +x backup.sh restore.sh setup-cron.sh
```

### 4. ç£ç¢Ÿç©ºé–“
å®šæœŸæª¢æŸ¥å‚™ä»½ç›®éŒ„çš„ç£ç¢Ÿç©ºé–“ä½¿ç”¨é‡ï¼š
```bash
du -sh ../../backups
```

### 5. ç”Ÿç”¢ç’°å¢ƒå»ºè­°
- å‚™ä»½æª”æ¡ˆå»ºè­°é¡å¤–ä¸Šå‚³åˆ°é›²ç«¯å„²å­˜ï¼ˆAWS S3ã€Google Cloud Storage ç­‰ï¼‰
- å®šæœŸæ¸¬è©¦é‚„åŸæµç¨‹ç¢ºä¿å‚™ä»½å¯ç”¨
- è¨­å®šå‚™ä»½å¤±æ•—æ™‚çš„å‘Šè­¦é€šçŸ¥
- è€ƒæ…®ä½¿ç”¨ç•°åœ°å‚™ä»½ç­–ç•¥

### 6. Zeabur éƒ¨ç½²ç’°å¢ƒ

#### å‚™ä»½æ–¹å¼

**æ–¹å¼ 1ï¼šæœ¬åœ°å®šæœŸåŸ·è¡Œå‚™ä»½ï¼ˆæ¨è–¦ï¼‰**
åœ¨æ‚¨çš„æœ¬åœ°é›»è…¦è¨­å®š cron jobï¼Œå®šæœŸåŸ·è¡Œ `zeabur-backup-auto.sh`ï¼š

```bash
# ç·¨è¼¯ crontab
crontab -e

# æ–°å¢ä»¥ä¸‹è¡Œï¼ˆæ¯æ—¥å‡Œæ™¨ 2:00 åŸ·è¡Œï¼‰
0 2 * * * cd /path/to/timerecord/scripts/backup && ./zeabur-backup-auto.sh >> ../../backups/zeabur/backup.log 2>&1
```

**æ–¹å¼ 2ï¼šä½¿ç”¨ Zeabur å…§å»ºå‚™ä»½**
æª¢æŸ¥ Zeabur PostgreSQL æœå‹™æ˜¯å¦æä¾›è‡ªå‹•å‚™ä»½åŠŸèƒ½ã€‚

**æ–¹å¼ 3ï¼šä¸Šå‚³åˆ°é›²ç«¯å„²å­˜**
ä¿®æ”¹ `zeabur-backup-auto.sh`ï¼Œåœ¨å‚™ä»½å¾Œè‡ªå‹•ä¸Šå‚³åˆ° AWS S3ã€Google Cloud Storage ç­‰ã€‚

#### è¨­å®šæ­¥é©Ÿ

1. **åœ¨æœ¬åœ°é›»è…¦è¨­å®š Zeabur å‚™ä»½ç’°å¢ƒ**
   ```bash
   cd scripts/backup
   cp zeabur.env.example zeabur.env
   # ç·¨è¼¯ zeabur.envï¼Œå¡«å…¥ Zeabur DATABASE_URL
   ```

2. **æ¸¬è©¦å‚™ä»½**
   ```bash
   ./zeabur-backup-auto.sh
   ```

3. **è¨­å®šè‡ªå‹•æ’ç¨‹**
   ```bash
   # macOS/Linux
   crontab -e
   # æ–°å¢å®šæ™‚ä»»å‹™ï¼ˆæ¯æ—¥å‡Œæ™¨ 2:00ï¼‰
   0 2 * * * cd /path/to/timerecord/scripts/backup && ./zeabur-backup-auto.sh
   ```

4. **ï¼ˆå¯é¸ï¼‰è¨­å®šé›²ç«¯ä¸Šå‚³**
   ç·¨è¼¯ `zeabur-backup-auto.sh`ï¼Œåœ¨å‚™ä»½å®Œæˆå¾ŒåŠ å…¥ï¼š
   ```bash
   # ä¸Šå‚³åˆ° AWS S3
   aws s3 cp "$BACKUP_PATH.gz" s3://your-bucket/backups/
   ```

## ç–‘é›£æ’è§£

### å•é¡Œ 1ï¼šæ‰¾ä¸åˆ° pg_dump å‘½ä»¤
```bash
# å®‰è£ PostgreSQL å®¢æˆ¶ç«¯å·¥å…·
brew install postgresql  # macOS
```

### å•é¡Œ 2ï¼šé€£ç·šè³‡æ–™åº«å¤±æ•—
```bash
# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
cat api/.env | grep DATABASE_URL

# æ¸¬è©¦é€£ç·š
psql "$DATABASE_URL" -c "SELECT version();"
```

### å•é¡Œ 3ï¼šcron æ²’æœ‰åŸ·è¡Œ
```bash
# æª¢æŸ¥ cron æ˜¯å¦é‹è¡Œ
sudo systemctl status cron  # Linux

# æŸ¥çœ‹ç³»çµ±æ—¥èªŒ
tail -f /var/log/syslog | grep CRON  # Linux
tail -f /var/log/system.log | grep cron  # macOS
```

### å•é¡Œ 4ï¼šæ¬Šé™ä¸è¶³
```bash
# ç¢ºä¿è…³æœ¬æœ‰åŸ·è¡Œæ¬Šé™
chmod +x scripts/backup/*.sh

# ç¢ºä¿å‚™ä»½ç›®éŒ„å¯å¯«å…¥
chmod 755 backups
```

## é€²éšåŠŸèƒ½

### è‡ªå‹•ä¸Šå‚³åˆ°é›²ç«¯å„²å­˜
å¯ä»¥ä¿®æ”¹ `backup.sh` åŠ å…¥é›²ç«¯ä¸Šå‚³åŠŸèƒ½ï¼š

```bash
# ç¯„ä¾‹ï¼šä¸Šå‚³åˆ° AWS S3
aws s3 cp "$BACKUP_PATH.gz" s3://your-bucket/backups/

# ç¯„ä¾‹ï¼šä¸Šå‚³åˆ° Google Cloud Storage
gsutil cp "$BACKUP_PATH.gz" gs://your-bucket/backups/
```

### å‚™ä»½å¤±æ•—é€šçŸ¥
å¯ä»¥åŠ å…¥ Email æˆ– Slack é€šçŸ¥ï¼š

```bash
# ç¯„ä¾‹ï¼šç™¼é€ Email
if ! pg_dump "$DATABASE_URL" > "$BACKUP_PATH"; then
    echo "å‚™ä»½å¤±æ•—" | mail -s "è³‡æ–™åº«å‚™ä»½å¤±æ•—" admin@example.com
fi
```

### å¢é‡å‚™ä»½
å¦‚æœè³‡æ–™é‡å¾ˆå¤§ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨ PostgreSQL çš„ WAL æ­¸æª”å’Œ PITR åŠŸèƒ½ã€‚

## æˆæ¬Š
MIT License
